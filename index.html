function exportSongToPDF(songName) {
    const songsMap = extractAllSongsFromPlaylists();
    const songData = songsMap.get(songName);
    
    if (!songData) {
        alert("Chanson non trouv√©e");
        return;
    }
    
    const lieuxArray = Array.from(songData.lieux);
    const datesArray = Array.from(songData.dates);
    
    const printWindow = window.open('', '_blank');
    
    // D√©tecter si c'est un mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    let content = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${songName} - Tourn√©e Europe 2026</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                /* Styles de base */
                body { 
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                    line-height: 1.4;
                    color: #2c3e50;
                    margin: ${isMobile ? '5mm' : '15mm'};
                    font-size: ${isMobile ? '14px' : '16px'};
                }
                
                .header { 
                    text-align: center; 
                    margin-bottom: 20px; 
                    padding-bottom: 15px;
                    border-bottom: 3px solid #9b59b6;
                }
                
                .header h1 { 
                    color: #2c3e50; 
                    margin-bottom: 8px;
                    font-size: ${isMobile ? '22px' : '26px'};
                }
                
                .song-stats { 
                    display: grid; 
                    grid-template-columns: repeat(3, 1fr);
                    gap: ${isMobile ? '10px' : '15px'}; 
                    margin-bottom: 20px;
                }
                
                .stat-card { 
                    background: white; 
                    padding: ${isMobile ? '12px' : '15px'}; 
                    border-radius: 8px; 
                    text-align: center;
                    border: 2px solid #9b59b6;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                
                .stat-number { 
                    font-size: ${isMobile ? '24px' : '30px'}; 
                    font-weight: bold; 
                    color: #9b59b6; 
                    margin-bottom: 5px;
                }
                
                .stat-label { 
                    color: #7f8c8d; 
                    font-size: ${isMobile ? '11px' : '12px'}; 
                    font-weight: 600;
                }
                
                .lieux-section { 
                    margin-top: 20px;
                }
                
                .lieu-table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 10px;
                    font-size: ${isMobile ? '12px' : '14px'};
                }
                
                .lieu-table th { 
                    background: #9b59b6; 
                    color: white; 
                    padding: ${isMobile ? '8px 10px' : '10px 12px'}; 
                    text-align: left;
                    font-weight: 600;
                    font-size: ${isMobile ? '12px' : '14px'};
                }
                
                .lieu-table td { 
                    padding: ${isMobile ? '6px 8px' : '8px 10px'}; 
                    border-bottom: 1px solid #eee;
                    word-break: break-word;
                }
                
                .lieu-table tr:nth-child(even) { 
                    background: #f8f9fa; 
                }
                
                .footer { 
                    margin-top: 25px; 
                    text-align: center; 
                    color: #7f8c8d; 
                    font-size: ${isMobile ? '10px' : '11px'};
                    padding-top: 15px;
                    border-top: 1px solid #ddd;
                }
                
                /* Optimisations pour mobile */
                @media (max-width: 768px) {
                    .song-stats {
                        grid-template-columns: 1fr;
                        gap: 8px;
                    }
                    
                    .lieu-table {
                        display: block;
                        overflow-x: auto;
                    }
                    
                    body {
                        margin: 3mm;
                        font-size: 13px;
                    }
                }
                
                /* Optimisations pour l'impression */
                @media print {
                    body { 
                        margin: ${isMobile ? '3mm' : '10mm'};
                        font-size: ${isMobile ? '12px' : '14px'};
                    }
                    
                    .song-stats {
                        page-break-inside: avoid;
                    }
                    
                    .lieu-table {
                        page-break-inside: avoid;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üéµ ${songName}</h1>
                <p>R√©capitulatif - Minist√®re Musical NY AKO</p>
                <p style="color: #7f8c8d; font-size: 0.9em;">Export: ${new Date().toLocaleDateString('fr-FR')}</p>
            </div>
            
            <div class="song-stats">
                <div class="stat-card">
                    <div class="stat-number">${songData.count}</div>
                    <div class="stat-label">Fois chant√©e</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${lieuxArray.length}</div>
                    <div class="stat-label">Lieux diff√©rents</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${datesArray.length}</div>
                    <div class="stat-label">Dates</div>
                </div>
            </div>
            
            <div class="lieux-section">
                <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; font-size: ${isMobile ? '18px' : '20px'}">
                    üìç Lieux d'interpr√©tation
                </h2>
                
                <table class="lieu-table">
                    <thead>
                        <tr>
                            <th>N¬∞</th>
                            <th>Lieu</th>
                            <th>Date correspondante</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Cr√©er un Map pour associer chaque lieu √† sa date
    const lieuDateMap = new Map();
    
    // Pour chaque lieu, trouver la date correspondante
    lieuxArray.forEach((lieu) => {
        let datePourCeLieu = 'Non dat√©';
        
        if (songData.rows && Array.isArray(songData.rows)) {
            songData.rows.forEach(rowIndex => {
                const row = sheetData[rowIndex];
                const lieuxCols = headers
                    .map((header, index) => 
                        (header && header.includes('Lieux')) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                lieuxCols.forEach(colIndex => {
                    const lieuValue = row[colIndex] || '';
                    if (lieuValue.includes(lieu)) {
                        const dateIndex = findHeaderIndex('Date:');
                        if (dateIndex !== -1) {
                            datePourCeLieu = row[dateIndex] || 'Non dat√©';
                        }
                    }
                });
            });
        }
        
        lieuDateMap.set(lieu, datePourCeLieu);
    });
    
    // Afficher les lieux avec leurs dates correspondantes
    Array.from(lieuDateMap.entries()).forEach(([lieu, date], index) => {
        content += `
                <tr>
                    <td style="font-weight: bold; color: #9b59b6;">${index + 1}</td>
                    <td style="font-weight: 600;">${lieu}</td>
                    <td>
                        <div style="font-size: 0.9em; color: #7f8c8d;">
                            üìÖ ${date}
                        </div>
                    </td>
                </tr>
        `;
    });
    
    content += `
                    </tbody>
                </table>
            </div>
    `;
    
    if (datesArray.length > 0) {
        content += `
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <h4 style="color: #2c3e50; margin-bottom: 8px; font-size: ${isMobile ? '14px' : '16px'}">
                    üìÖ Toutes les dates :
                </h4>
                <div style="padding: 8px; background: white; border-radius: 4px;">
                    <p style="color: #7f8c8d; margin: 0; font-size: 0.9em;">${datesArray.join(', ')}</p>
                </div>
            </div>
        `;
    }
    
    content += `
            <div class="footer">
                <p><strong>NY AKO - Groupe artistique -LLB Madagascar</strong></p>
                <p style="font-size: 0.9em;">"Que la parole de Christ habite parmi vous abondamment" (Colossiens 3:16)</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(content);
    printWindow.document.close();
    
    // Donner plus de temps sur mobile
    setTimeout(() => {
        try {
            printWindow.print();
        } catch (error) {
            // Fallback pour mobile
            alert("L'impression a √©chou√©. Le PDF est ouvert dans un nouvel onglet.");
        }
    }, isMobile ? 1000 : 500);
}
