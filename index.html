<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal de Bord - Tourn√©e Europe 2026</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --dark-blue: #1a2530;
            --light-blue: #aed6f1;
            --note-bg: #fff9c4;
            --note-border: #ffd54f;
            --concert-bg: #e8f4fc;
            --activity-bg: #f8f9fa;
            --concert-orange: #ff9800;
            --neutral-border: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, #e8f4f8 0%, #d1e7f5 100%);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .special-frame {
            position: relative;
            padding: 15px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--light-blue), var(--secondary-color));
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 12px solid transparent;
            background-clip: padding-box;
            overflow: hidden;
        }
        
        .special-frame::before {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            background: linear-gradient(45deg, var(--secondary-color), var(--light-blue), var(--secondary-color));
            border-radius: 26px;
            z-index: -1;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            color: var(--text-color);
            position: relative;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
        }
        
        h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
            color: var(--dark-blue);
        }
        
        .journal-entry {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            overflow: hidden;
            border: 2px solid var(--neutral-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .journal-entry:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .entry-header {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 15px 20px;
        }
        
        .entry-title {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .entry-date {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .entry-content {
            padding: 25px;
        }
        
        .section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px dashed #e0e0e0;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 1.5em;
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--light-blue);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 8px;
            height: 25px;
            background: var(--secondary-color);
            border-radius: 4px;
        }
        
        .subsection-title {
            font-size: 1.2em;
            color: var(--primary-color);
            margin: 20px 0 15px;
            padding-left: 15px;
            border-left: 4px solid var(--accent-color);
            font-weight: 600;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--secondary-color);
            font-size: 1.05em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .inline-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .inline-item {
            flex: 1;
        }
        
        .note-box {
            background-color: var(--note-bg);
            border: 2px solid var(--note-border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }
        
        .note-box:hover {
            transform: translateX(5px);
        }
        
        .note-title {
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .note-title::before {
            content: 'üìù';
            font-size: 1.2em;
        }
        
        .highlight-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-color);
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
            border: 1px solid #e9ecef;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }
        
        .photo-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            text-decoration: none;
            margin: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .photo-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .photo-button::before {
            content: 'üì∏';
            font-size: 1.1em;
        }
        
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 2px solid var(--neutral-border);
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .search-button {
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .filters-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 2px solid #e9ecef;
            transition: transform 0.2s ease;
        }
        
        .filter-group:hover {
            transform: translateY(-3px);
        }
        
        .filter-group h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .tag {
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .calendar-section {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border: 2px solid var(--neutral-border);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendar-nav button {
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-nav button:hover {
            transform: scale(1.05);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 12px;
            background-color: var(--light-color);
            border-radius: 6px;
            font-weight: 600;
        }
        
        .calendar-day {
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .calendar-day.has-data {
            background-color: #e8f4f8;
            font-weight: 700;
            border-color: var(--secondary-color);
        }
        
        .calendar-day.selected {
            background: linear-gradient(to bottom, var(--secondary-color), var(--primary-color));
            color: white;
            transform: scale(1.05);
        }
        
        .calendar-day-number {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .calendar-day-lieux {
            font-size: 0.7em;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 60px;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border: 2px solid var(--neutral-border);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.8em;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .success-message {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .activity-section {
            background: var(--activity-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 6px solid var(--secondary-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .activity-section:hover {
            transform: translateX(5px);
        }
        
        .concert-section {
            background: var(--concert-bg);
            border-left: 6px solid var(--concert-orange);
        }
        
        .activity-title {
            font-size: 1.4em;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: center;
            justify-content: center;
        }
        
        .activity-title.concert-title {
            color: var(--concert-orange);
        }
        
        .activity-title::before {
            content: 'üéµ';
            font-size: 1.3em;
        }
        
        .activity-title.activity-type::before {
            content: 'üìÖ';
        }
        
        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        .debug-info {
            display: none;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .photos-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .photos-title {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .photos-title::before {
            content: 'üñºÔ∏è';
            font-size: 1.2em;
        }
        
        .admin-section {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--neutral-border);
        }
        
        .admin-panel {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .admin-button {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .admin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .admin-button:disabled {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stats-row .stat-card {
            flex: 1;
            min-width: auto;
        }
        
        .activity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .activity-stat {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .activity-stat:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .activity-stat.concert-stat {
            cursor: default;
        }
        
        .activity-stat.concert-stat:hover {
            transform: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .activity-stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .activity-stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .concert-filter-button {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .concert-filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .concert-filter-button.active {
            background: linear-gradient(to bottom, #27ae60, #219a52);
        }
        
        .email-link {
            color: #3498db;
            text-decoration: none;
        }
        
        .email-link:hover {
            text-decoration: underline;
        }
        
        .password-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 200px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-blue);
        }
        
        .modal-title {
            font-size: 1.5em;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--accent-color);
            padding: 5px;
        }
        
        .email-recipients {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .recipient-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .recipient-item:last-child {
            border-bottom: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .form-textarea {
            height: 150px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .action-button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .action-button.primary {
            background: linear-gradient(to bottom, #27ae60, #219a52);
            color: white;
        }
        
        .action-button.secondary {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            color: white;
        }
        
        .action-button.cancel {
            background: linear-gradient(to bottom, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background: #f8f9fa;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .export-option {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }
        
        .export-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        /* Nouveaux styles pour l'affichage des informations interlocuteur */
        .contact-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid var(--neutral-border);
        }
        
        .contact-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--neutral-border);
        }
        
        .contact-header h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.2em;
        }
        
        .contact-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .contact-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        
        .contact-value {
            flex: 1;
            font-weight: 500;
        }
        
        .contact-value a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .contact-value a:hover {
            text-decoration: underline;
        }
        
        .trajet-info {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .trajet-item {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        
        .trajet-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .trajet-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* NOUVEAUX STYLES POUR LES HEURES ET TRAJET - SIMILAIRES √Ä "INFORMATION SUR INTERLOCUTEUR" */
        .heure-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .heure-item {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .heure-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }
        
        .heure-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .heure-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Nouveaux styles pour les lieux */
        .lieux-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .lieux-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        
        .lieux-icon {
            font-size: 1.5em;
            margin-bottom: 8px;
        }
        
        .lieux-label {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .lieux-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* Bouton mot de passe */
        .password-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }
        
        .password-button {
            background: linear-gradient(to bottom, #8e44ad, #7d3c98);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .password-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .password-input-container {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* NOUVEAUX STYLES POUR LES FICHES EN VUE MOBILE */
        .info-grid-mobile {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item-mobile {
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .filters-section {
                grid-template-columns: 1fr;
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .inline-group {
                flex-direction: column;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .activity-title {
                font-size: 1.2em;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-controls {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .action-button {
                width: 100%;
            }
            
            .contact-details {
                grid-template-columns: 1fr;
            }
            
            .trajet-info {
                flex-direction: column;
            }
            
            .heure-group {
                flex-direction: column;
            }
            
            .lieux-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 10px;
            }
            
            .calendar-day-lieux {
                font-size: 0.6em;
                max-height: 50px;
            }
            
            /* Styles sp√©cifiques pour les fiches en mobile */
            .info-grid-mobile {
                grid-template-columns: 1fr;
            }
            
            .lieux-info {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .lieux-item {
                min-height: 70px;
                padding: 12px;
            }
            
            .lieux-icon {
                font-size: 1.3em;
            }
            
            .lieux-value {
                font-size: 1em;
            }
            
            .heure-group {
                flex-direction: row;
                gap: 10px;
            }
            
            .heure-item {
                min-height: 70px;
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .lieux-info {
                grid-template-columns: 1fr;
            }
            
            .heure-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="special-frame">
            <header>
                <h1>üìì Journal de Bord - Tourn√©e Europe 2026</h1>
                <p>NY AKO - Suivi d√©taill√© des activit√©s quotidiennes</p>
            </header>
        </div>
        
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="üîç Rechercher dans le journal...">
                <button type="submit" class="search-button">Rechercher</button>
                <button type="button" class="concert-filter-button" id="concertFilterButton">
                    üéµ Filtrer les concerts
                </button>
            </form>
            
            <div class="password-section">
                <button class="password-button" id="passwordButton">
                    üîì Acc√®s aux liens de fiches
                </button>
                <div class="password-input-container" id="passwordInputContainer">
                    <label for="passwordInput">Mot de passe:</label>
                    <input type="password" id="passwordInput" class="form-input" placeholder="Entrez le mot de passe...">
                    <button class="search-button" id="submitPassword" style="margin-top: 10px;">Valider</button>
                </div>
            </div>
            
            <div class="filters-section">
                <div class="filter-group">
                    <h3>üìç Lieux</h3>
                    <div class="filter-tags" id="lieuxTags"></div>
                </div>
                
                <div class="filter-group">
                    <h3>üë§ Interlocuteurs/H√¥tes</h3>
                    <div class="filter-tags" id="nomsTags"></div>
                </div>
                
                <div class="filter-group">
                    <h3>üåç Pays</h3>
                    <div class="filter-tags" id="paysTags"></div>
                </div>
            </div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="totalLieux">0</div>
                    <div class="stat-label">Lieux visit√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPays">0</div>
                    <div class="stat-label">Pays visit√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalInterlocuteurs">0</div>
                    <div class="stat-label">Interlocuteurs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalParticipants">0</div>
                    <div class="stat-label">Participants total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDureeTrajet">0 h</div>
                    <div class="stat-label">Dur√©e trajet total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDistance">0 km</div>
                    <div class="stat-label">Distance totale</div>
                </div>
            </div>
            
            <div class="activity-stats" id="activityStats"></div>
            
            <div class="calendar-section">
                <div class="calendar-header">
                    <h3>üìÖ Calendrier des journ√©es</h3>
                    <div class="calendar-nav">
                        <button id="prevMonth">‚óÄ</button>
                        <span id="currentMonth">Mois en cours</span>
                        <button id="nextMonth">‚ñ∂</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            
            <button id="showAllButton" class="search-button" style="width: 100%; margin-top: 10px;">
                üìã Afficher toutes les journ√©es
            </button>
            <button id="retryButton" class="search-button" style="background: linear-gradient(135deg, #f39c12, #e67e22); width: 100%; margin-top: 10px; display: none;">
                üîÑ R√©essayer le chargement
            </button>
        </section>
        
        <div class="admin-section" id="adminSection">
            <h3>üîê Panneau d'administration</h3>
            <div class="admin-panel">
                <p>Acc√®s aux fonctionnalit√©s avanc√©es</p>
                <div class="admin-controls">
                    <button class="admin-button" id="groupEmailButton" disabled>üìß Envoi mail group√©</button>
                    <button class="admin-button" id="organizeListsButton" disabled>üìã Listes organis√©es</button>
                    <button class="admin-button" id="exportDataButton" disabled>üíæ Exporter les donn√©es</button>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Chargement des donn√©es depuis Google Sheets...</p>
        </div>

        <div id="dataInfo"></div>
        <div id="debugInfo"></div>
        
        <div id="journalEntries"></div>
    </div>

    <!-- Modal pour l'envoi d'emails group√©s -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìß Envoi d'email group√©</h3>
                <button class="close-modal" id="closeEmailModal">‚úï</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Destinataires avec email:</label>
                <div id="emailRecipients" class="email-recipients">
                    <!-- Liste des destinataires g√©n√©r√©e ici -->
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <span id="recipientCount">0</span> destinataire(s) s√©lectionn√©(s)
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Sujet:</label>
                <input type="text" id="emailSubject" class="form-input" 
                       value="Tourn√©e Europe 2026 - Suivi des activit√©s">
            </div>
            
            <div class="form-group">
                <label class="form-label">Message:</label>
                <textarea id="emailMessage" class="form-textarea">Bonjour,

Voici le suivi de nos activit√©s durant la tourn√©e Europe 2026.

Cordialement,
L'√©quipe NY AKO</textarea>
            </div>
            
            <div class="modal-actions">
                <button class="action-button cancel" id="cancelEmail">Annuler</button>
                <button class="action-button secondary" id="copyEmails">üìã Copier les adresses</button>
                <button class="action-button primary" id="sendEmails">üìß Envoyer les emails</button>
            </div>
        </div>
    </div>

    <!-- Modal pour les listes organis√©es -->
    <div id="listsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìã Listes organis√©es</h3>
                <button class="close-modal" id="closeListsModal">‚úï</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Type de liste:</label>
                <select id="listType" class="form-input">
                    <option value="interlocuteurs">üë§ Interlocuteurs/H√¥tes</option>
                    <option value="concerts">üéµ Concerts</option>
                    <option value="activites">üìÖ Activit√©s par type</option>
                    <option value="pays">üåç Par pays</option>
                    <option value="lieux">üìç Par lieu</option>
                </select>
            </div>
            
            <div class="list-container" id="organizedList">
                <!-- Liste organis√©e g√©n√©r√©e ici -->
            </div>
            
            <div class="modal-actions">
                <button class="action-button cancel" id="cancelLists">Fermer</button>
                <button class="action-button secondary" id="exportList">üìÑ Exporter cette liste</button>
            </div>
        </div>
    </div>

    <!-- Modal pour l'export de donn√©es -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üíæ Export des donn√©es</h3>
                <button class="close-modal" id="closeExportModal">‚úï</button>
            </div>
            
            <div class="export-options">
                <div class="export-option" data-format="csv">
                    <div class="export-icon">üìä</div>
                    <h4>CSV</h4>
                    <p>Format tableur compatible Excel</p>
                </div>
                
                <div class="export-option" data-format="json">
                    <div class="export-icon">üîß</div>
                    <h4>JSON</h4>
                    <p>Format technique pour d√©veloppeurs</p>
                </div>
                
                <div class="export-option" data-format="pdf">
                    <div class="export-icon">üìÑ</div>
                    <h4>PDF</h4>
                    <p>Rapport imprimable</p>
                </div>
                
                <div class="export-option" data-format="excel">
                    <div class="export-icon">üìà</div>
                    <h4>Excel</h4>
                    <p>Fichier XLSX optimis√©</p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Options d'export:</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="includeContacts" checked>
                        Inclure les contacts
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="includePhotos" checked>
                        Inclure les liens photos
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="includeStats" checked>
                        Inclure les statistiques
                    </label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="action-button cancel" id="cancelExport">Annuler</button>
                <button class="action-button primary" id="confirmExport" disabled>üíæ Exporter</button>
            </div>
        </div>
    </div>

    <script>
        // URL du Google Sheets
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXIJyclDLf2asT-FMnmaeWMSPtQHxpAC1wiGJ_xzXbl2StziwiUw9ElW9XyK5yemQ-PHaWlRQbtdHb/pub?gid=395832865&single=true&output=csv';
        
        // Variables globales
        let sheetData = [];
        let headers = [];
        let datesWithData = [];
        let currentDate = new Date();
        let selectedDate = null;
        let allLieux = [];
        let allInterlocuteurs = [];
        let allPays = [];
        let totalDureeTrajet = 0;
        let totalDistance = 0;
        let totalParticipants = 0;
        let currentSearchTerm = '';
        let currentSearchType = '';
        let isAdmin = false;
        let showOnlyConcerts = false;
        let showFicheLinks = false;
        let activityCounts = {
            'Rencontre/Invitation': 0,
            'Concert': 0,
            'Ecole': 0,
            'Sortie/visite/Tourisme': 0,
            'Eglise/culte': 0,
            'March√©': 0,
            'Shopping': 0
        };
        let selectedExportFormat = null;

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ D√©marrage du Journal de Bord...');
            
            // Configuration des √©v√©nements
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            document.getElementById('prevMonth').addEventListener('click', prevMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            document.getElementById('showAllButton').addEventListener('click', showAllData);
            document.getElementById('retryButton').addEventListener('click', loadDataFromGoogleSheets);
            document.getElementById('concertFilterButton').addEventListener('click', toggleConcertFilter);
            
            // √âv√©nements pour l'admin
            document.getElementById('groupEmailButton').addEventListener('click', showEmailModal);
            document.getElementById('organizeListsButton').addEventListener('click', showListsModal);
            document.getElementById('exportDataButton').addEventListener('click', showExportModal);
            
            // √âv√©nements pour les modales
            document.getElementById('closeEmailModal').addEventListener('click', () => hideModal('emailModal'));
            document.getElementById('cancelEmail').addEventListener('click', () => hideModal('emailModal'));
            document.getElementById('closeListsModal').addEventListener('click', () => hideModal('listsModal'));
            document.getElementById('cancelLists').addEventListener('click', () => hideModal('listsModal'));
            document.getElementById('closeExportModal').addEventListener('click', () => hideModal('exportModal'));
            document.getElementById('cancelExport').addEventListener('click', () => hideModal('exportModal'));
            
            // √âv√©nements pour les fonctionnalit√©s
            document.getElementById('sendEmails').addEventListener('click', sendEmails);
            document.getElementById('copyEmails').addEventListener('click', copyEmailAddresses);
            document.getElementById('listType').addEventListener('change', updateOrganizedList);
            document.getElementById('exportList').addEventListener('click', exportCurrentList);
            document.getElementById('confirmExport').addEventListener('click', exportData);
            
            // √âv√©nements pour les options d'export
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.export-option').forEach(opt => {
                        opt.style.borderColor = '#e9ecef';
                        opt.style.background = '#f8f9fa';
                    });
                    this.style.borderColor = 'var(--secondary-color)';
                    this.style.background = '#e8f4f8';
                    selectedExportFormat = this.getAttribute('data-format');
                    document.getElementById('confirmExport').disabled = false;
                });
            });
            
            // √âv√©nements pour le mot de passe
            document.getElementById('passwordButton').addEventListener('click', togglePasswordInput);
            document.getElementById('submitPassword').addEventListener('click', validatePassword);
            
            // V√©rifier si l'admin est d√©j√† connect√©
            checkAdminStatus();
            
            // Charger les donn√©es
            loadDataFromGoogleSheets();
        });

        // Fonctions pour les modales
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // V√©rifier le statut admin
        function checkAdminStatus() {
            const savedAdmin = localStorage.getItem('tourneeAdmin');
            if (savedAdmin === 'true') {
                isAdmin = true;
                enableAdminButtons();
            }
        }

        // Activer les boutons admin
        function enableAdminButtons() {
            document.querySelectorAll('.admin-button').forEach(button => {
                button.disabled = false;
            });
        }

        // Toggle du champ de mot de passe
        function togglePasswordInput() {
            const passwordContainer = document.getElementById('passwordInputContainer');
            passwordContainer.style.display = passwordContainer.style.display === 'none' ? 'block' : 'none';
        }

        // Validation du mot de passe
        function validatePassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === 'admin') {
                isAdmin = true;
                showFicheLinks = true;
                document.getElementById('passwordInputContainer').style.display = 'none';
                document.getElementById('passwordInput').value = '';
                
                // Enregistrer le statut admin
                localStorage.setItem('tourneeAdmin', 'true');
                
                // Activer les boutons admin
                enableAdminButtons();
                
                // Afficher un message de succ√®s
                const dataInfo = document.getElementById('dataInfo');
                dataInfo.innerHTML = `
                    <div class="success-message">
                        ‚úÖ Acc√®s administrateur activ√©
                    </div>
                `;
                dataInfo.style.display = 'block';
                
                // Si des r√©sultats sont d√©j√† affich√©s, les mettre √† jour
                if (document.getElementById('journalEntries').children.length > 0) {
                    displayAllJournalEntries();
                }
            } else {
                alert('Mot de passe incorrect. Veuillez r√©essayer.');
            }
        }

        // Chargement des donn√©es depuis Google Sheets
        async function loadDataFromGoogleSheets() {
            console.log('üì• Chargement des donn√©es depuis Google Sheets...');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('retryButton').style.display = 'none';
            
            try {
                // Essayer plusieurs m√©thodes de r√©cup√©ration
                let csvText = '';
                
                // M√©thode 1: Essayer directement
                try {
                    const response = await fetch(GOOGLE_SHEETS_URL);
                    if (response.ok) {
                        csvText = await response.text();
                        console.log('‚úÖ Donn√©es r√©cup√©r√©es directement');
                    }
                } catch (directError) {
                    console.log('‚ùå √âchec m√©thode directe, essai avec proxy...');
                    
                    // M√©thode 2: Utiliser un proxy CORS
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const timestamp = new Date().getTime();
                    const url = `${proxyUrl}${encodeURIComponent(GOOGLE_SHEETS_URL)}&t=${timestamp}`;
                    
                    const proxyResponse = await fetch(url);
                    if (!proxyResponse.ok) {
                        throw new Error(`Erreur proxy: ${proxyResponse.status}`);
                    }
                    csvText = await proxyResponse.text();
                    console.log('‚úÖ Donn√©es r√©cup√©r√©es via proxy');
                }
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Aucune donn√©e re√ßue');
                }
                
                processCSVData(csvText);
                
            } catch (error) {
                console.error('‚ùå Erreur de chargement:', error);
                showError('Impossible de charger les donn√©es. V√©rifiez que le Google Sheet est bien publi√© et accessible.');
                document.getElementById('retryButton').style.display = 'block';
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        // Traitement des donn√©es CSV
        function processCSVData(csvText) {
            try {
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Le fichier CSV est vide');
                }
                
                console.log('üìÑ Contenu CSV re√ßu:', csvText.substring(0, 500) + '...');
                
                const lines = parseCSV(csvText);
                
                if (!lines || lines.length === 0) {
                    throw new Error('Aucune donn√©e pars√©e du CSV');
                }
                
                headers = lines[0] || [];
                sheetData = lines.slice(1).filter(row => 
                    row && row.some(cell => cell && cell.trim() !== '')
                );
                
                console.log('‚úÖ Donn√©es charg√©es:', sheetData.length, 'entr√©es');
                console.log('üìã En-t√™tes:', headers);
                
                if (sheetData.length === 0) {
                    throw new Error('Aucune entr√©e de journal trouv√©e dans le fichier');
                }
                
                // Traitement des donn√©es
                extractDatesWithData();
                extractAllLieux();
                extractAllInterlocuteurs();
                extractAllPays();
                calculateTotals();
                calculateActivityCounts();
                updateStats();
                renderFilterTags();
                renderCalendar();
                renderActivityStats();
                
                showDataInfo();
                displayAllJournalEntries();
                
            } catch (error) {
                console.error('‚ùå Erreur de traitement:', error);
                showError('Erreur lors du traitement des donn√©es: ' + error.message);
            }
        }

        // Calculer les comptages d'activit√©s
        function calculateActivityCounts() {
            // R√©initialiser les compteurs
            Object.keys(activityCounts).forEach(key => {
                activityCounts[key] = 0;
            });
            
            // Rechercher les colonnes d'activit√©s
            const activityColumns = headers
                .map((header, index) => 
                    (header && (header.includes('ACTIVIT√â') || header.includes('CONCERT'))) ? index : -1
                )
                .filter(index => index !== -1);
            
            // Compter les activit√©s par type
            sheetData.forEach(row => {
                activityColumns.forEach(colIndex => {
                    const activityType = row[colIndex] || '';
                    if (activityType && activityType.trim() !== '') {
                        // V√©rifier si le type correspond √† l'un de nos types d'activit√©
                        Object.keys(activityCounts).forEach(type => {
                            if (activityType.includes(type)) {
                                activityCounts[type]++;
                            }
                        });
                        
                        // Compter les concerts s√©par√©ment
                        if ((activityType.toLowerCase().includes('concert') || activityType === 'OUI') && 
                            (headers[colIndex] && headers[colIndex].includes('CONCERT'))) {
                            activityCounts['Concert']++;
                        }
                    }
                });
            });
        }

        // Afficher les statistiques d'activit√©s
        function renderActivityStats() {
            const container = document.getElementById('activityStats');
            container.innerHTML = '';
            
            Object.keys(activityCounts).forEach(type => {
                if (activityCounts[type] > 0) {
                    const statDiv = document.createElement('div');
                    statDiv.className = 'activity-stat';
                    
                    // Pour les concerts, on ne veut pas que ce soit cliquable
                    if (type === 'Concert') {
                        statDiv.classList.add('concert-stat');
                    } else {
                        statDiv.setAttribute('data-activity-type', type);
                    }
                    
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'activity-stat-value';
                    valueDiv.textContent = activityCounts[type];
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'activity-stat-label';
                    labelDiv.textContent = type;
                    
                    statDiv.appendChild(valueDiv);
                    statDiv.appendChild(labelDiv);
                    
                    // Ajouter l'√©v√©nement de clic pour filtrer par type d'activit√© (sauf pour les concerts)
                    if (type !== 'Concert') {
                        statDiv.addEventListener('click', function() {
                            filterByActivityType(type);
                        });
                    }
                    
                    container.appendChild(statDiv);
                }
            });
        }

        // Filtrer par type d'activit√©
        function filterByActivityType(activityType) {
            const results = [];
            
            sheetData.forEach(row => {
                // Rechercher les colonnes d'activit√©s
                const activityColumns = headers
                    .map((header, index) => 
                        (header && (header.includes('ACTIVIT√â') || header.includes('CONCERT'))) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                // V√©rifier si cette ligne a l'activit√© recherch√©e
                const hasActivity = activityColumns.some(colIndex => {
                    const value = row[colIndex] || '';
                    return value && value.includes(activityType);
                });
                
                if (hasActivity) {
                    results.push(row);
                }
            });
            
            displayFilteredEntries(results, `Activit√©: ${activityType}`);
        }

        // Parser CSV am√©lior√©
        function parseCSV(csvText) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentLine.push(currentField);
                    lines.push(currentLine);
                    currentLine = [];
                    currentField = '';
                } else if (char === '\r') {
                    continue;
                } else {
                    currentField += char;
                }
            }
            
            if (currentField !== '' || currentLine.length > 0) {
                currentLine.push(currentField);
                lines.push(currentLine);
            }
            
            return lines;
        }

        // Extraction des dates avec donn√©es (colonne B)
        function extractDatesWithData() {
            datesWithData = [];
            const dateColumnIndex = 1; // Colonne B
            
            sheetData.forEach((row, index) => {
                const dateStr = row[dateColumnIndex] || '';
                if (dateStr && dateStr.trim() !== '') {
                    const date = parseDate(dateStr);
                    if (date) {
                        // Extraire les lieux pour cette date
                        const lieux = extractLieuxForDate(row);
                        
                        datesWithData.push({
                            date: date,
                            dateStr: dateStr,
                            rowIndex: index,
                            lieux: lieux
                        });
                    }
                }
            });
            
            datesWithData.sort((a, b) => a.date - b.date);
        }

        // Extraction des lieux pour une date donn√©e
        function extractLieuxForDate(row) {
            const lieux = [];
            
            // Rechercher les colonnes de lieux
            const lieuxColumns = headers
                .map((header, index) => 
                    (header && header.includes('Lieux')) ? index : -1
                )
                .filter(index => index !== -1);
            
            lieuxColumns.forEach(colIndex => {
                const value = row[colIndex] || '';
                if (value && value.trim() !== '') {
                    lieux.push(value.trim());
                }
            });
            
            return [...new Set(lieux)]; // Supprimer les doublons
        }

        // Extraction de tous les lieux
        function extractAllLieux() {
            const allLieuxSet = new Set();
            
            headers.forEach((header, index) => {
                if (header && header.includes('Lieux')) {
                    sheetData.forEach(row => {
                        const value = row[index] || '';
                        if (value.trim()) allLieuxSet.add(value.trim());
                    });
                }
            });
            
            allLieux = Array.from(allLieuxSet).sort();
        }

        // Extraction de tous les interlocuteurs/h√¥tes (noms seulement)
        function extractAllInterlocuteurs() {
            const allInterlocuteursSet = new Set();
            
            const interlocuteurColumnIndex = headers.findIndex(header => 
                header && header.trim() === "Interlocuteur ,h√¥te"
            );
            
            if (interlocuteurColumnIndex !== -1) {
                sheetData.forEach(row => {
                    const value = row[interlocuteurColumnIndex] || '';
                    if (value.trim()) {
                        value.split(/[,;]/).forEach(nom => {
                            const trimmed = nom.trim();
                            // Exclure les URLs et les adresses
                            if (trimmed && !trimmed.includes('http') && !trimmed.includes('@') && !trimmed.includes('facebook')) {
                                allInterlocuteursSet.add(trimmed);
                            }
                        });
                    }
                });
            }
            
            allInterlocuteurs = Array.from(allInterlocuteursSet).sort();
        }

        // Extraction de tous les pays
        function extractAllPays() {
            const allPaysSet = new Set();
            
            headers.forEach((header, index) => {
                if (header && header.includes('Pays')) {
                    sheetData.forEach(row => {
                        const value = row[index] || '';
                        if (value.trim()) allPaysSet.add(value.trim());
                    });
                }
            });
            
            allPays = Array.from(allPaysSet).sort();
        }

        // Calcul des totaux pour les statistiques
        function calculateTotals() {
            totalDureeTrajet = 0;
            totalDistance = 0;
            totalParticipants = 0;
            
            headers.forEach((header, index) => {
                if (header && header.includes('Dur√©e trajet')) {
                    sheetData.forEach(row => {
                        const value = row[index] || '';
                        if (value.trim()) {
                            const num = parseFloat(value.replace(',', '.')) || 0;
                            totalDureeTrajet += num;
                        }
                    });
                }
                
                if (header && header.includes('Distance trajet')) {
                    sheetData.forEach(row => {
                        const value = row[index] || '';
                        if (value.trim()) {
                            const num = parseFloat(value.replace(',', '.')) || 0;
                            totalDistance += num;
                        }
                    });
                }
                
                if (header && header.includes('Nb participant')) {
                    sheetData.forEach(row => {
                        const value = row[index] || '';
                        if (value.trim()) {
                            const num = parseInt(value) || 0;
                            totalParticipants += num;
                        }
                    });
                }
            });
        }

        // Mise √† jour des statistiques
        function updateStats() {
            document.getElementById('totalLieux').textContent = allLieux.length;
            document.getElementById('totalPays').textContent = allPays.length;
            document.getElementById('totalInterlocuteurs').textContent = allInterlocuteurs.length;
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('totalDureeTrajet').textContent = totalDureeTrajet.toFixed(1) + ' h';
            document.getElementById('totalDistance').textContent = totalDistance.toFixed(0) + ' km';
        }

        // Rendu des tags de filtre
        function renderFilterTags() {
            renderTags('lieuxTags', allLieux, 'lieu');
            renderTags('nomsTags', allInterlocuteurs, 'nom');
            renderTags('paysTags', allPays, 'pays');
        }

        // Rendu des tags pour un type donn√©
        function renderTags(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div style="color: #7f8c8d; font-style: italic;">Aucun ' + type + ' trouv√©</div>';
                return;
            }
            
            items.forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = item;
                
                tag.addEventListener('click', () => {
                    currentSearchTerm = item;
                    currentSearchType = type;
                    const results = filterDataByType(item, type);
                    displayFilteredEntries(results, `${type.charAt(0).toUpperCase() + type.slice(1)}: ${item}`);
                });
                
                container.appendChild(tag);
            });
        }

        // Filtrage des donn√©es par type
        function filterDataByType(value, type) {
            let columnIndices = [];
            
            switch(type) {
                case 'lieu':
                    columnIndices = headers
                        .map((header, index) => header.includes('Lieux') ? index : -1)
                        .filter(index => index !== -1);
                    break;
                case 'nom':
                    columnIndices = [headers.findIndex(header => 
                        header && header.trim() === "Interlocuteur ,h√¥te"
                    )].filter(index => index !== -1);
                    break;
                case 'pays':
                    columnIndices = headers
                        .map((header, index) => header.includes('Pays') ? index : -1)
                        .filter(index => index !== -1);
                    break;
            }
            
            if (columnIndices.length === 0) return [];
            
            return sheetData.filter(row => {
                return columnIndices.some(index => {
                    const cellValue = row[index] || '';
                    return cellValue.includes(value);
                });
            });
        }

        // Rendu du calendrier avec lieux
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthElement = document.getElementById('currentMonth');
            
            monthElement.textContent = currentDate.toLocaleDateString('fr-FR', {
                month: 'long',
                year: 'numeric'
            });
            
            grid.innerHTML = '';
            
            ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            let startDay = firstDay.getDay();
            startDay = startDay === 0 ? 6 : startDay - 1;
            
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }
            
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                const dayData = datesWithData.find(d => 
                    d.date.getDate() === date.getDate() &&
                    d.date.getMonth() === date.getMonth() &&
                    d.date.getFullYear() === date.getFullYear()
                );
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = i;
                day.appendChild(dayNumber);
                
                if (dayData) {
                    day.classList.add('has-data');
                    
                    const lieuxDiv = document.createElement('div');
                    lieuxDiv.className = 'calendar-day-lieux';
                    
                    // Afficher tous les lieux
                    lieuxDiv.textContent = dayData.lieux.join(', ');
                    
                    day.appendChild(lieuxDiv);
                }
                
                if (selectedDate && 
                    selectedDate.getDate() === i &&
                    selectedDate.getMonth() === currentDate.getMonth() &&
                    selectedDate.getFullYear() === currentDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                day.addEventListener('click', () => {
                    if (dayData) {
                        selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
                    }
                });
                
                grid.appendChild(day);
            }
        }

        // S√©lection d'une date
        function selectDate(date) {
            selectedDate = date;
            const matchingRows = findEntriesByDate(date);
            displayFilteredEntries(matchingRows, `Journal du ${formatDateForDisplay(date)}`);
            renderCalendar();
        }

        // Recherche des entr√©es par date
        function findEntriesByDate(date) {
            const dateColumnIndex = 1;
            
            return sheetData.filter(row => {
                const rowDateStr = row[dateColumnIndex] || '';
                const rowDate = parseDate(rowDateStr);
                return rowDate && 
                       rowDate.getDate() === date.getDate() &&
                       rowDate.getMonth() === date.getMonth() &&
                       rowDate.getFullYear() === date.getFullYear();
            });
        }

        // Parse une date
        function parseDate(dateStr) {
            const formats = [
                /(\d{2})\/(\d{2})\/(\d{4})/,
                /(\d{4})-(\d{2})-(\d{2})/,
                /(\d{2})-(\d{2})-(\d{4})/
            ];
            
            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    if (format === formats[0]) {
                        return new Date(match[3], match[2] - 1, match[1]);
                    } else {
                        return new Date(match[1], match[2] - 1, match[3]);
                    }
                }
            }
            
            const nativeDate = new Date(dateStr);
            return isNaN(nativeDate.getTime()) ? null : nativeDate;
        }

        // Formatage d'une date pour l'affichage
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Gestion de la recherche
        function handleSearch(event) {
            event.preventDefault();
            const searchValue = document.getElementById('searchInput').value.trim();
            
            if (!searchValue) {
                alert('Veuillez entrer un mot ou une phrase pour la recherche');
                return;
            }
            
            currentSearchTerm = searchValue;
            currentSearchType = 'text';
            const results = searchData(searchValue);
            displayFilteredEntries(results, `R√©sultats pour "${searchValue}"`);
        }

        // Recherche dans les donn√©es
        function searchData(searchValue) {
            const searchLower = searchValue.toLowerCase();
            return sheetData.filter(row => 
                row.some(cell => cell && cell.toLowerCase().includes(searchLower))
            );
        }

        // Basculer le filtre des concerts
        function toggleConcertFilter() {
            showOnlyConcerts = !showOnlyConcerts;
            const button = document.getElementById('concertFilterButton');
            
            if (showOnlyConcerts) {
                button.classList.add('active');
                button.textContent = 'üéµ Voir toutes les activit√©s';
                filterConcertsOnly();
            } else {
                button.classList.remove('active');
                button.textContent = 'üéµ Filtrer les concerts';
                displayAllJournalEntries();
            }
        }

        // Filtrer uniquement les concerts
        function filterConcertsOnly() {
            const concertRows = [];
            
            sheetData.forEach(row => {
                // Rechercher les colonnes de concert
                const concertColumns = headers
                    .map((header, index) => 
                        (header && header.includes('CONCERT')) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                // V√©rifier si cette ligne a au moins un concert
                const hasConcert = concertColumns.some(colIndex => {
                    const value = row[colIndex] || '';
                    return value && (value.toLowerCase().includes('concert') || value === 'OUI');
                });
                
                if (hasConcert) {
                    concertRows.push(row);
                }
            });
            
            displayFilteredEntries(concertRows, 'Concerts uniquement');
        }

        // Affichage de tous les messages
        function showAllData() {
            currentSearchTerm = '';
            currentSearchType = '';
            showOnlyConcerts = false;
            document.getElementById('concertFilterButton').classList.remove('active');
            document.getElementById('concertFilterButton').textContent = 'üéµ Filtrer les concerts';
            displayAllJournalEntries();
        }

        // Affichage de toutes les entr√©es de journal
        function displayAllJournalEntries() {
            const container = document.getElementById('journalEntries');
            container.innerHTML = '';
            
            if (sheetData.length === 0) {
                container.innerHTML = '<div class="no-data">Aucune donn√©e de journal disponible</div>';
                return;
            }
            
            sheetData.forEach((row, index) => {
                container.appendChild(generateJournalEntry(row, index));
            });
        }

        // Affichage des entr√©es filtr√©es
        function displayFilteredEntries(results, title) {
            const container = document.getElementById('journalEntries');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>‚ùå Aucune journ√©e trouv√©e</h3>
                        <p>Aucune journ√©e ne correspond √† votre recherche</p>
                    </div>
                `;
                return;
            }
            
            const header = document.createElement('div');
            header.style.background = 'linear-gradient(135deg, #e8f4fc, #d1e7f5)';
            header.style.padding = '15px 20px';
            header.style.borderRadius = '10px';
            header.style.marginBottom = '25px';
            header.style.border = '2px solid var(--neutral-border)';
            header.innerHTML = `<strong style="font-size: 1.1em;">${results.length} journ√©e(s) trouv√©e(s)</strong> pour : "${title}"`;
            container.appendChild(header);
            
            results.forEach((row, index) => {
                container.appendChild(generateJournalEntry(row, index));
            });
            
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // G√©n√©ration d'une entr√©e de journal selon la nouvelle structure
        function generateJournalEntry(row, index) {
            const dateIndex = 1;
            const dateStr = row[dateIndex] || 'Date non sp√©cifi√©e';
            const dayNumber = index + 1;
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'journal-entry';
            
            // En-t√™te avec titre et date
            const headerDiv = document.createElement('div');
            headerDiv.className = 'entry-header';
            headerDiv.innerHTML = `
                <h2 class="entry-title">Jour ${dayNumber}</h2>
                <div class="entry-date">Date: ${dateStr}</div>
            `;
            entryDiv.appendChild(headerDiv);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'entry-content';
            
            // 1. Donn√©es g√©n√©rales de la journ√©e
            contentDiv.appendChild(createGeneralInfoSection(row));
            
            // 2. Donn√©es par cat√©gories (Concerts et Activit√©s)
            contentDiv.appendChild(createActivitiesSection(row));
            
            // 3. Donn√©es g√©n√©rales de fin de journ√©e
            contentDiv.appendChild(createEndOfDaySection(row));
            
            // 4. Section admin (si connect√©) ou liens de fiches (si mot de passe valid√©)
            if (isAdmin || showFicheLinks) {
                contentDiv.appendChild(createAdminSection(row));
            }
            
            entryDiv.appendChild(contentDiv);
            
            return entryDiv;
        }

        // Cr√©ation de la section d'informations g√©n√©rales
        function createGeneralInfoSection(row) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            // Titre de section
            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Informations G√©n√©rales';
            sectionDiv.appendChild(title);
            
            // Grille d'informations adapt√©e mobile
            const infoGrid = document.createElement('div');
            infoGrid.className = 'info-grid-mobile'; // Nouvelle classe pour mobile
            
            // Date
            const dateIndex = findHeaderIndex('Date:');
            if (dateIndex !== -1 && row[dateIndex]) {
                infoGrid.appendChild(createInfoItem('Date:', row[dateIndex]));
            }
            
            // Pays
            const paysIndex = findHeaderIndex('Pays:');
            if (paysIndex !== -1 && row[paysIndex]) {
                infoGrid.appendChild(createInfoItem('Pays:', row[paysIndex]));
            }
            
            // Au Programme
            const programmeIndices = findAllHeaderIndices('Au Programme:');
            if (programmeIndices.length > 0) {
                let programmeValues = [];
                programmeIndices.forEach(index => {
                    if (row[index]) {
                        programmeValues.push(row[index]);
                    }
                });
                
                if (programmeValues.length > 0) {
                    infoGrid.appendChild(createInfoItem('Au Programme:', programmeValues.join(', ')));
                }
            }
            
            sectionDiv.appendChild(infoGrid);
            
            return sectionDiv;
        }

        // Cr√©ation de la section des activit√©s
        function createActivitiesSection(row) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            // Titre de section
            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Activit√©s de la Journ√©e';
            sectionDiv.appendChild(title);
            
            // Recherche flexible des sections d'activit√©s
            const activitySections = findActivitySectionsInHeaders();
            let hasActivities = false;
            
            activitySections.forEach(section => {
                const activityData = extractActivityData(row, section.index, section.prefix);
                
                if (section.type === 'concert') {
                    // Pour les concerts, v√©rifier si c'est "OUI"
                    if (activityData.type && activityData.type.toLowerCase() === 'oui') {
                        sectionDiv.appendChild(createConcertSection(activityData, section.prefix));
                        hasActivities = true;
                    }
                } else {
                    // Pour les activit√©s, v√©rifier si c'est un type valide
                    const validActivityTypes = [
                        'Rencontre/Invitation', 'Concert', 'Ecole', 
                        'Sortie/visite/Tourisme', 'Eglise/culte', 'March√©', 'Shopping',
                        'Rencontre' // Ajout√© bas√© sur votre exemple
                    ];
                    
                    if (activityData.type && validActivityTypes.includes(activityData.type)) {
                        sectionDiv.appendChild(createActivitySection(activityData, section.prefix, activityData.type));
                        hasActivities = true;
                    }
                }
            });
            
            if (!hasActivities) {
                const noActivities = document.createElement('div');
                noActivities.className = 'no-data';
                noActivities.textContent = 'Aucune activit√© trouv√©e pour cette journ√©e';
                sectionDiv.appendChild(noActivities);
            }
            
            return sectionDiv;
        }

        // RECHERCHE AM√âLIOR√âE DES SECTIONS D'ACTIVIT√âS
        function findActivitySectionsInHeaders() {
            const sections = [];
            
            console.log('üîç Recherche des sections d\'activit√©s dans les en-t√™tes...');
            
            // Recherche plus flexible pour les activit√©s
            headers.forEach((header, index) => {
                if (!header) return;
                
                const headerUpper = header.toUpperCase().trim();
                
                // D√©tection des concerts
                if (headerUpper.includes('CONCERT')) {
                    const concertNumber = extractNumber(headerUpper);
                    const prefix = concertNumber ? `CONCERT ${concertNumber}` : 'CONCERT';
                    
                    sections.push({
                        prefix: prefix,
                        type: 'concert',
                        index: index
                    });
                    console.log(`üéµ Concert d√©tect√©: ${header} -> ${prefix}`);
                }
                
                // D√©tection des activit√©s
                else if (headerUpper.includes('ACTIVIT√â') || headerUpper.includes('ACTIVITE')) {
                    const activityNumber = extractNumber(headerUpper);
                    const prefix = activityNumber ? `ACTIVIT√â ${activityNumber}` : 'ACTIVIT√â';
                    
                    sections.push({
                        prefix: prefix,
                        type: 'activity',
                        index: index
                    });
                    console.log(`üìÖ Activit√© d√©tect√©e: ${header} -> ${prefix}`);
                }
                
                // D√©tection des activit√©s avec num√©ros (1, 2, 3, etc.)
                else if (/ACTIVIT√â?\s*\d+|ACTIVITY\s*\d+/i.test(header)) {
                    const activityNumber = extractNumber(headerUpper);
                    const prefix = `ACTIVIT√â ${activityNumber || '1'}`;
                    
                    sections.push({
                        prefix: prefix,
                        type: 'activity',
                        index: index
                    });
                    console.log(`üìÖ Activit√© num√©rot√©e d√©tect√©e: ${header} -> ${prefix}`);
                }
            });
            
            // Trier les sections pour avoir un ordre logique
            sections.sort((a, b) => {
                // D'abord les concerts, puis les activit√©s
                if (a.type !== b.type) {
                    return a.type === 'concert' ? -1 : 1;
                }
                // Ensuite par num√©ro
                const numA = extractNumber(a.prefix);
                const numB = extractNumber(b.prefix);
                return (numA || 0) - (numB || 0);
            });
            
            console.log(`‚úÖ Sections d'activit√©s trouv√©es: ${sections.length}`);
            sections.forEach(section => {
                console.log(`   - ${section.prefix} (${section.type}) √† l'index ${section.index}`);
            });
            
            return sections;
        }

        // Fonction utilitaire pour extraire les num√©ros des en-t√™tes
        function extractNumber(text) {
            const match = text.match(/\d+/);
            return match ? parseInt(match[0]) : null;
        }

        // Extraction des donn√©es d'une section d'activit√©
        function extractActivityData(row, activityIndex, prefix) {
            const data = {};
            
            // Le type d'activit√© est dans la colonne de l'activit√© elle-m√™me
            data.type = row[activityIndex] || '';
            
            // Les champs suivis dans l'ordre s√©quentiel
            const startIndex = activityIndex + 1;
            
            // Mapping des champs dans l'ordre attendu bas√© sur votre exemple
            const fieldMapping = [
                { name: 'heureDebut', patterns: ['Heure d√©but:', 'Heure d√©but'] },
                { name: 'heureFin', patterns: ['Heure fin:', 'Heure fin'] },
                { name: 'lieux', patterns: ['Lieux :', 'Lieux'] },
                { name: 'trajet', patterns: ['Trajet:', 'Trajet'] },
                { name: 'dureeTrajet', patterns: ['Dur√©e trajet:', 'Dur√©e trajet'] },
                { name: 'distanceTrajet', patterns: ['Distance trajet:', 'Distance trajet'] },
                { name: 'details', patterns: ['D√©tails sur l\'activit√©:', 'D√©tails sur l\'activit√©'] },
                { name: 'faits', patterns: ['Faits marquants et Anecdote:', 'Faits marquants et Anecdote'] },
                { name: 'observations', patterns: ['Observations :', 'Observations'] },
                { name: 'nbParticipant', patterns: ['Nb participant:', 'Nb participant'] },
                { name: 'interlocuteur', patterns: ['Interlocuteur ,h√¥te', 'Interlocuteur'] },
                { name: 'telephone', patterns: ['T√©l√©phone', 'Telephone'] },
                { name: 'whatsapp', patterns: ['Whatsapp', 'WhatsApp'] },
                { name: 'mail', patterns: ['Mail:'] },
                { name: 'reseauxSociaux', patterns: ['fb ou autre contact sur r√©seaux sociaux de l\'h√¥te'] },
                { name: 'photosLieux', patterns: ['Photos des lieux (ext√©rieur ,int√©rieur, coulisse)'] },
                { name: 'repertoire', patterns: ['R√©pertoire:'] },
                { name: 'photosGroupe', patterns: ['Photos de groupe,marquante'] }
            ];
            
            // Parcourir les colonnes suivantes pour trouver les donn√©es
            let currentIndex = startIndex;
            fieldMapping.forEach(field => {
                if (currentIndex < headers.length) {
                    // V√©rifier si l'en-t√™te correspond √† l'un des patterns
                    const header = headers[currentIndex] || '';
                    const isMatching = field.patterns.some(pattern => 
                        header.includes(pattern)
                    );
                    
                    if (isMatching && row[currentIndex]) {
                        data[field.name] = row[currentIndex];
                    }
                    currentIndex++;
                }
            });
            
            return data;
        }

        // Cr√©ation d'une section de concert
        function createConcertSection(activityData, concertPrefix) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'activity-section concert-section';
            
            // Titre de l'activit√©
            const activityTitle = document.createElement('h4');
            activityTitle.className = 'activity-title concert-title';
            
            // Construire le titre selon le format demand√©
            let title = `${concertPrefix}`;
            if (activityData.lieux) {
                title += ` √† ${activityData.lieux}`;
            } else {
                title += ` √† Lieu non sp√©cifi√©`;
            }
            
            activityTitle.textContent = title;
            sectionDiv.appendChild(activityTitle);
            
            // Heures d√©but et fin c√¥te √† c√¥te avec emojis
            if (activityData.heureDebut || activityData.heureFin) {
                const heureGroup = document.createElement('div');
                heureGroup.className = 'heure-group';
                
                if (activityData.heureDebut) {
                    const heureItem = document.createElement('div');
                    heureItem.className = 'heure-item';
                    heureItem.innerHTML = `
                        <div class="heure-icon">üïê</div>
                        <div class="heure-label">Heure d√©but</div>
                        <div class="heure-value">${activityData.heureDebut}</div>
                    `;
                    heureGroup.appendChild(heureItem);
                }
                
                if (activityData.heureFin) {
                    const heureItem = document.createElement('div');
                    heureItem.className = 'heure-item';
                    heureItem.innerHTML = `
                        <div class="heure-icon">üïî</div>
                        <div class="heure-label">Heure fin</div>
                        <div class="heure-value">${activityData.heureFin}</div>
                    `;
                    heureGroup.appendChild(heureItem);
                }
                
                sectionDiv.appendChild(heureGroup);
            }
            
            // Concernant les lieux
            if (activityData.lieux || activityData.trajet || activityData.dureeTrajet || activityData.distanceTrajet) {
                const lieuSubtitle = document.createElement('h5');
                lieuSubtitle.className = 'subsection-title';
                lieuSubtitle.textContent = 'Concernant les lieux:';
                sectionDiv.appendChild(lieuSubtitle);
                
                // Informations sur les lieux en grille 2x2 pour mobile
                const lieuxInfo = document.createElement('div');
                lieuxInfo.className = 'lieux-info';
                
                if (activityData.lieux) {
                    const lieuItem = document.createElement('div');
                    lieuItem.className = 'lieux-item';
                    lieuItem.innerHTML = `
                        <div class="lieux-icon">üìç</div>
                        <div class="lieux-label">Lieux</div>
                        <div class="lieux-value">${activityData.lieux}</div>
                    `;
                    lieuxInfo.appendChild(lieuItem);
                }
                
                if (activityData.trajet) {
                    const trajetItem = document.createElement('div');
                    trajetItem.className = 'lieux-item';
                    trajetItem.innerHTML = `
                        <div class="lieux-icon">üõ£Ô∏è</div>
                        <div class="lieux-label">Trajet</div>
                        <div class="lieux-value">${activityData.trajet}</div>
                    `;
                    lieuxInfo.appendChild(trajetItem);
                }
                
                if (activityData.dureeTrajet) {
                    const dureeItem = document.createElement('div');
                    dureeItem.className = 'lieux-item';
                    dureeItem.innerHTML = `
                        <div class="lieux-icon">‚è±Ô∏è</div>
                        <div class="lieux-label">Dur√©e</div>
                        <div class="lieux-value">${activityData.dureeTrajet} Heures</div>
                    `;
                    lieuxInfo.appendChild(dureeItem);
                }
                
                if (activityData.distanceTrajet) {
                    const distanceItem = document.createElement('div');
                    distanceItem.className = 'lieux-item';
                    distanceItem.innerHTML = `
                        <div class="lieux-icon">üìè</div>
                        <div class="lieux-label">Distance</div>
                        <div class="lieux-value">${activityData.distanceTrajet} Km</div>
                    `;
                    lieuxInfo.appendChild(distanceItem);
                }
                
                sectionDiv.appendChild(lieuxInfo);
            }
            
            // Notes
            if (activityData.details || activityData.faits || activityData.observations) {
                const notesSubtitle = document.createElement('h5');
                notesSubtitle.className = 'subsection-title';
                notesSubtitle.textContent = 'Notes';
                sectionDiv.appendChild(notesSubtitle);
                
                // D√©tails sur l'activit√©
                if (activityData.details) {
                    sectionDiv.appendChild(createNoteBox('D√©tails sur l\'activit√©:', activityData.details));
                }
                
                // Faits marquants et Anecdote
                if (activityData.faits) {
                    sectionDiv.appendChild(createNoteBox('Faits marquants et Anecdote:', activityData.faits));
                }
                
                // Observations
                if (activityData.observations) {
                    sectionDiv.appendChild(createNoteBox('Observations:', activityData.observations));
                }
            }
            
            // Nombre de participants
            if (activityData.nbParticipant) {
                const participantsDiv = document.createElement('div');
                participantsDiv.className = 'highlight-value';
                participantsDiv.innerHTML = `<strong>Nb participant:</strong> ${activityData.nbParticipant} personne(s)`;
                sectionDiv.appendChild(participantsDiv);
            }
            
            // Informations sur l'Organisateur/H√¥te
            if (activityData.interlocuteur || activityData.telephone || activityData.whatsapp || 
                activityData.mail || activityData.reseauxSociaux) {
                sectionDiv.appendChild(createContactInfoSection(activityData));
            }
            
            // Liens de photos
            if (activityData.photosLieux || activityData.repertoire || activityData.photosGroupe) {
                const photosDiv = document.createElement('div');
                photosDiv.className = 'photos-section';
                
                const photosTitle = document.createElement('div');
                photosTitle.className = 'photos-title';
                photosTitle.textContent = 'Liens des photos';
                photosDiv.appendChild(photosTitle);
                
                if (activityData.photosLieux) {
                    const photoButton = createPhotoButton('Photos des lieux', activityData.photosLieux);
                    photosDiv.appendChild(photoButton);
                }
                
                if (activityData.repertoire) {
                    const photoButton = createPhotoButton('R√©pertoire', activityData.repertoire);
                    photosDiv.appendChild(photoButton);
                }
                
                if (activityData.photosGroupe) {
                    const photoButton = createPhotoButton('Photos de groupe', activityData.photosGroupe);
                    photosDiv.appendChild(photoButton);
                }
                
                sectionDiv.appendChild(photosDiv);
            }
            
            return sectionDiv;
        }

        // Cr√©ation d'une section d'activit√©
        function createActivitySection(activityData, activityPrefix, activityType) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'activity-section';
            
            // Titre de l'activit√©
            const activityTitle = document.createElement('h4');
            activityTitle.className = 'activity-title activity-type';
            
            // Construire le titre selon le format demand√© - "Type - Interlocuteur √† Lieu"
            let title = activityType;
            if (activityData.interlocuteur) {
                title += ` - ${activityData.interlocuteur}`;
            }
            if (activityData.lieux) {
                title += ` √† ${activityData.lieux}`;
            }
            
            activityTitle.textContent = title;
            sectionDiv.appendChild(activityTitle);
            
            // Heures d√©but et fin c√¥te √† c√¥te avec emojis
            if (activityData.heureDebut || activityData.heureFin) {
                const heureGroup = document.createElement('div');
                heureGroup.className = 'heure-group';
                
                if (activityData.heureDebut) {
                    const heureItem = document.createElement('div');
                    heureItem.className = 'heure-item';
                    heureItem.innerHTML = `
                        <div class="heure-icon">üïê</div>
                        <div class="heure-label">Heure d√©but</div>
                        <div class="heure-value">${activityData.heureDebut}</div>
                    `;
                    heureGroup.appendChild(heureItem);
                }
                
                if (activityData.heureFin) {
                    const heureItem = document.createElement('div');
                    heureItem.className = 'heure-item';
                    heureItem.innerHTML = `
                        <div class="heure-icon">üïî</div>
                        <div class="heure-label">Heure fin</div>
                        <div class="heure-value">${activityData.heureFin}</div>
                    `;
                    heureGroup.appendChild(heureItem);
                }
                
                sectionDiv.appendChild(heureGroup);
            }
            
            // Concernant les lieux
            if (activityData.lieux || activityData.trajet || activityData.dureeTrajet || activityData.distanceTrajet) {
                const lieuSubtitle = document.createElement('h5');
                lieuSubtitle.className = 'subsection-title';
                lieuSubtitle.textContent = 'Concernant les lieux:';
                sectionDiv.appendChild(lieuSubtitle);
                
                // Informations sur les lieux en grille 2x2 pour mobile
                const lieuxInfo = document.createElement('div');
                lieuxInfo.className = 'lieux-info';
                
                if (activityData.lieux) {
                    const lieuItem = document.createElement('div');
                    lieuItem.className = 'lieux-item';
                    lieuItem.innerHTML = `
                        <div class="lieux-icon">üìç</div>
                        <div class="lieux-label">Lieux</div>
                        <div class="lieux-value">${activityData.lieux}</div>
                    `;
                    lieuxInfo.appendChild(lieuItem);
                }
                
                if (activityData.trajet) {
                    const trajetItem = document.createElement('div');
                    trajetItem.className = 'lieux-item';
                    trajetItem.innerHTML = `
                        <div class="lieux-icon">üõ£Ô∏è</div>
                        <div class="lieux-label">Trajet</div>
                        <div class="lieux-value">${activityData.trajet}</div>
                    `;
                    lieuxInfo.appendChild(trajetItem);
                }
                
                if (activityData.dureeTrajet) {
                    const dureeItem = document.createElement('div');
                    dureeItem.className = 'lieux-item';
                    dureeItem.innerHTML = `
                        <div class="lieux-icon">‚è±Ô∏è</div>
                        <div class="lieux-label">Dur√©e</div>
                        <div class="lieux-value">${activityData.dureeTrajet} Heures</div>
                    `;
                    lieuxInfo.appendChild(dureeItem);
                }
                
                if (activityData.distanceTrajet) {
                    const distanceItem = document.createElement('div');
                    distanceItem.className = 'lieux-item';
                    distanceItem.innerHTML = `
                        <div class="lieux-icon">üìè</div>
                        <div class="lieux-label">Distance</div>
                        <div class="lieux-value">${activityData.distanceTrajet} Km</div>
                    `;
                    lieuxInfo.appendChild(distanceItem);
                }
                
                sectionDiv.appendChild(lieuxInfo);
            }
            
            // Notes
            if (activityData.details || activityData.faits || activityData.observations) {
                const notesSubtitle = document.createElement('h5');
                notesSubtitle.className = 'subsection-title';
                notesSubtitle.textContent = 'Notes';
                sectionDiv.appendChild(notesSubtitle);
                
                // D√©tails sur l'activit√©
                if (activityData.details) {
                    sectionDiv.appendChild(createNoteBox('D√©tails sur l\'activit√©:', activityData.details));
                }
                
                // Faits marquants et Anecdote
                if (activityData.faits) {
                    sectionDiv.appendChild(createNoteBox('Faits marquants et Anecdote:', activityData.faits));
                }
                
                // Observations
                if (activityData.observations) {
                    sectionDiv.appendChild(createNoteBox('Observations:', activityData.observations));
                }
            }
            
            // Nombre de participants
            if (activityData.nbParticipant) {
                const participantsDiv = document.createElement('div');
                participantsDiv.className = 'highlight-value';
                participantsDiv.innerHTML = `<strong>Nb participant:</strong> ${activityData.nbParticipant} personne(s)`;
                sectionDiv.appendChild(participantsDiv);
            }
            
            // Informations sur l'Organisateur/H√¥te
            if (activityData.interlocuteur || activityData.telephone || activityData.whatsapp || 
                activityData.mail || activityData.reseauxSociaux) {
                sectionDiv.appendChild(createContactInfoSection(activityData));
            }
            
            // Liens de photos
            if (activityData.photosLieux || activityData.repertoire || activityData.photosGroupe) {
                const photosDiv = document.createElement('div');
                photosDiv.className = 'photos-section';
                
                const photosTitle = document.createElement('div');
                photosTitle.className = 'photos-title';
                photosTitle.textContent = 'Liens des photos';
                photosDiv.appendChild(photosTitle);
                
                if (activityData.photosLieux) {
                    const photoButton = createPhotoButton('Photos des lieux', activityData.photosLieux);
                    photosDiv.appendChild(photoButton);
                }
                
                if (activityData.repertoire) {
                    const photoButton = createPhotoButton('R√©pertoire', activityData.repertoire);
                    photosDiv.appendChild(photoButton);
                }
                
                if (activityData.photosGroupe) {
                    const photoButton = createPhotoButton('Photos de groupe', activityData.photosGroupe);
                    photosDiv.appendChild(photoButton);
                }
                
                sectionDiv.appendChild(photosDiv);
            }
            
            return sectionDiv;
        }

        // Cr√©ation de la section d'informations de contact
        function createContactInfoSection(activityData) {
            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-info';
            
            // En-t√™te
            const contactHeader = document.createElement('div');
            contactHeader.className = 'contact-header';
            contactHeader.innerHTML = `
                <span class="contact-icon">üìû</span>
                <h4>Information sur Interlocuteur ,h√¥te</h4>
            `;
            contactDiv.appendChild(contactHeader);
            
            // D√©tails des contacts
            const contactDetails = document.createElement('div');
            contactDetails.className = 'contact-details';
            
            // Nom de l'interlocuteur/h√¥te
            if (activityData.interlocuteur) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <span class="contact-icon">üë§</span>
                    <span class="contact-value">${activityData.interlocuteur}</span>
                `;
                contactDetails.appendChild(contactItem);
            }
            
            // T√©l√©phone
            if (activityData.telephone) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <span class="contact-icon">üî¢</span>
                    <span class="contact-value">${activityData.telephone}</span>
                `;
                contactDetails.appendChild(contactItem);
            }
            
            // WhatsApp
            if (activityData.whatsapp) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <span class="contact-icon">üí¨</span>
                    <span class="contact-value">${activityData.whatsapp}</span>
                `;
                contactDetails.appendChild(contactItem);
            }
            
            // Email
            if (activityData.mail) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <span class="contact-icon">üìß</span>
                    <span class="contact-value">${formatEmail(activityData.mail)}</span>
                `;
                contactDetails.appendChild(contactItem);
            }
            
            // R√©seaux sociaux
            if (activityData.reseauxSociaux) {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <span class="contact-icon">üë•</span>
                    <span class="contact-value">${activityData.reseauxSociaux}</span>
                `;
                contactDetails.appendChild(contactItem);
            }
            
            contactDiv.appendChild(contactDetails);
            
            return contactDiv;
        }

        // Cr√©ation de la section de fin de journ√©e
        function createEndOfDaySection(row) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            // Titre de section
            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'Bilan de la Journ√©e';
            sectionDiv.appendChild(title);
            
            // Notes
            const notesSubtitle = document.createElement('h5');
            notesSubtitle.className = 'subsection-title';
            notesSubtitle.textContent = 'Notes';
            sectionDiv.appendChild(notesSubtitle);
            
            // RESUME
            const resumeIndex = findHeaderIndex('RESUME');
            if (resumeIndex !== -1 && row[resumeIndex]) {
                sectionDiv.appendChild(createNoteBox('RESUME', row[resumeIndex]));
            }
            
            // Note de la journ√©e
            const noteIndex = findHeaderIndex('Note de la journ√©e:');
            if (noteIndex !== -1 && row[noteIndex]) {
                sectionDiv.appendChild(createNoteBox('Note de la journ√©e:', row[noteIndex]));
            }
            
            return sectionDiv;
        }

        // Cr√©ation de la section admin
        function createAdminSection(row) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            
            // Titre de section
            const title = document.createElement('h3');
            title.className = 'section-title';
            title.textContent = 'üîê Informations Administrateur';
            sectionDiv.appendChild(title);
            
            // Lien de fiche
            const ficheIndex = findHeaderIndex('Lien de cette fiche:');
            if (ficheIndex !== -1 && row[ficheIndex]) {
                sectionDiv.appendChild(createInfoItem('Lien de cette fiche:', row[ficheIndex]));
            }
            
            return sectionDiv;
        }

        // Fonctions utilitaires pour cr√©er des √©l√©ments d'interface
        function createInfoItem(label, value) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'info-item';
            
            const labelSpan = document.createElement('div');
            labelSpan.className = 'info-label';
            labelSpan.textContent = label;
            
            const valueDiv = document.createElement('div');
            valueDiv.className = 'info-value';
            
            // Convertir les URLs en liens
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            valueDiv.innerHTML = value.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
            
            itemDiv.appendChild(labelSpan);
            itemDiv.appendChild(valueDiv);
            
            return itemDiv;
        }

        function createNoteBox(title, content) {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'note-box';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'note-title';
            titleDiv.textContent = title;
            
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = content;
            
            noteDiv.appendChild(titleDiv);
            noteDiv.appendChild(contentDiv);
            
            return noteDiv;
        }

        function createPhotoButton(text, url) {
            const button = document.createElement('a');
            button.className = 'photo-button';
            button.href = url;
            button.target = '_blank';
            button.rel = 'noopener noreferrer';
            button.textContent = text;
            
            return button;
        }

        // Formater les emails pour les rendre cliquables
        function formatEmail(emailText) {
            const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi;
            return emailText.replace(emailRegex, function(email) {
                return `<a href="mailto:${email}" class="email-link">${email}</a>`;
            });
        }

        // Fonctions utilitaires pour trouver des en-t√™tes
        function findHeaderIndex(headerText) {
            return headers.findIndex(header => 
                header && header.trim() === headerText
            );
        }

        function findAllHeaderIndices(headerText) {
            const indices = [];
            headers.forEach((header, index) => {
                if (header && header.includes(headerText)) {
                    indices.push(index);
                }
            });
            return indices;
        }

        // Navigation dans le calendrier
        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // Fonctions pour l'envoi d'emails group√©s
        function showEmailModal() {
            const modal = document.getElementById('emailModal');
            const recipientsContainer = document.getElementById('emailRecipients');
            const recipientCount = document.getElementById('recipientCount');
            
            // R√©cup√©rer tous les interlocuteurs avec email
            const interlocuteursAvecEmail = [];
            const emailsDejaVus = new Set();
            
            sheetData.forEach(row => {
                // Rechercher les colonnes email
                const emailColumns = headers
                    .map((header, index) => 
                        (header && (header.includes('Mail') || header.includes('Email'))) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                // Rechercher les colonnes nom
                const nomColumns = headers
                    .map((header, index) => 
                        (header && header.includes('Interlocuteur')) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                emailColumns.forEach(emailCol => {
                    nomColumns.forEach(nomCol => {
                        const email = row[emailCol] || '';
                        const nom = row[nomCol] || '';
                        
                        if (email && email.trim() && nom && nom.trim()) {
                            const emailClean = email.trim().toLowerCase();
                            if (!emailsDejaVus.has(emailClean)) {
                                emailsDejaVus.add(emailClean);
                                interlocuteursAvecEmail.push({
                                    nom: nom,
                                    email: email
                                });
                            }
                        }
                    });
                });
            });
            
            recipientsContainer.innerHTML = '';
            interlocuteursAvecEmail.forEach((interlocuteur, index) => {
                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'recipient-item';
                recipientDiv.innerHTML = `
                    <input type="checkbox" class="recipient-checkbox" data-index="${index}" checked style="margin-right: 10px;">
                    <div>
                        <strong>${interlocuteur.nom}</strong><br>
                        <small style="color: #666;">${interlocuteur.email}</small>
                    </div>
                `;
                recipientsContainer.appendChild(recipientDiv);
            });
            
            recipientCount.textContent = interlocuteursAvecEmail.length;
            showModal('emailModal');
        }

        function copyEmailAddresses() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const emails = [];
            
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-index'));
                const recipientDiv = checkbox.closest('.recipient-item');
                const email = recipientDiv.querySelector('small').textContent;
                emails.push(email);
            });
            
            if (emails.length === 0) {
                alert('Aucun email √† copier');
                return;
            }
            
            const emailString = emails.join('; ');
            navigator.clipboard.writeText(emailString).then(() => {
                alert(`${emails.length} adresse(s) email copi√©e(s) dans le presse-papier`);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                // Fallback pour les navigateurs qui ne supportent pas clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = emailString;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`${emails.length} adresse(s) email copi√©e(s) dans le presse-papier`);
            });
        }

        function sendEmails() {
            const checkboxes = document.querySelectorAll('.recipient-checkbox:checked');
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (checkboxes.length === 0) {
                alert('Veuillez s√©lectionner au moins un destinataire');
                return;
            }
            
            // R√©cup√©rer les emails s√©lectionn√©s
            const emails = [];
            checkboxes.forEach(checkbox => {
                const recipientDiv = checkbox.closest('.recipient-item');
                const nom = recipientDiv.querySelector('strong').textContent;
                const email = recipientDiv.querySelector('small').textContent;
                emails.push({ nom, email });
            });
            
            // Pr√©parer le corps de l'email
            const emailBody = message;
            
            // Ouvrir le client email par d√©faut
            const encodedBody = encodeURIComponent(emailBody);
            const encodedSubject = encodeURIComponent(subject);
            
            // Pour Gmail (ou autre client email)
            const emailRecipients = emails.map(e => e.email).join(',');
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${emailRecipients}&su=${encodedSubject}&body=${encodedBody}`;
            
            window.open(gmailUrl, '_blank');
            
            alert(`${emails.length} email(s) pr√©par√©(s) pour envoi. V√©rifiez les destinataires avant d'envoyer.`);
            
            // Fermer la modale
            hideModal('emailModal');
        }

        // Fonctions pour les listes organis√©es
        function showListsModal() {
            showModal('listsModal');
            updateOrganizedList();
        }

        function updateOrganizedList() {
            const listType = document.getElementById('listType').value;
            const listContainer = document.getElementById('organizedList');
            
            let listData = [];
            let listTitle = '';
            
            switch(listType) {
                case 'interlocuteurs':
                    listData = allInterlocuteurs;
                    listTitle = 'Interlocuteurs/H√¥tes';
                    break;
                case 'concerts':
                    listData = getConcertsList();
                    listTitle = 'Concerts';
                    break;
                case 'activites':
                    listData = getActivitiesByType();
                    listTitle = 'Activit√©s par type';
                    break;
                case 'pays':
                    listData = allPays;
                    listTitle = 'Pays visit√©s';
                    break;
                case 'lieux':
                    listData = allLieux;
                    listTitle = 'Lieux visit√©s';
                    break;
            }
            
            let html = `<h4 style="margin-bottom: 15px; color: var(--primary-color);">${listTitle} (${listData.length})</h4>`;
            
            if (Array.isArray(listData)) {
                listData.forEach((item, index) => {
                    if (typeof item === 'string') {
                        html += `
                            <div class="list-item">
                                <span>${item}</span>
                                <span class="tag">${getItemCount(item, listType)}</span>
                            </div>
                        `;
                    } else if (typeof item === 'object') {
                        // Pour les objets (comme dans getActivitiesByType)
                        html += `
                            <div class="list-item">
                                <span>${item.type}</span>
                                <span class="tag">${item.count}</span>
                            </div>
                        `;
                    }
                });
            } else if (typeof listData === 'object') {
                // Pour les objets complexes (comme dans getConcertsList)
                Object.keys(listData).forEach(key => {
                    html += `
                        <div class="list-item">
                            <span>${key}</span>
                            <span class="tag">${listData[key]}</span>
                        </div>
                    `;
                });
            }
            
            listContainer.innerHTML = html;
        }

        function getConcertsList() {
            const concerts = {};
            
            sheetData.forEach(row => {
                // Rechercher les colonnes de concert
                const concertColumns = headers
                    .map((header, index) => 
                        (header && header.includes('CONCERT')) ? index : -1
                    )
                    .filter(index => index !== -1);
                
                concertColumns.forEach(colIndex => {
                    const concertType = headers[colIndex] || '';
                    const concertValue = row[colIndex] || '';
                    
                    if (concertValue && (concertValue.toLowerCase().includes('concert') || concertValue === 'OUI')) {
                        if (!concerts[concertType]) {
                            concerts[concertType] = 0;
                        }
                        concerts[concertType]++;
                    }
                });
            });
            
            return concerts;
        }

        function getActivitiesByType() {
            const activities = [];
            
            Object.keys(activityCounts).forEach(type => {
                if (activityCounts[type] > 0) {
                    activities.push({
                        type: type,
                        count: activityCounts[type]
                    });
                }
            });
            
            return activities.sort((a, b) => b.count - a.count);
        }

        function getItemCount(item, listType) {
            switch(listType) {
                case 'interlocuteurs':
                    return sheetData.filter(row => {
                        const interlocuteurCol = headers.findIndex(h => h && h.trim() === "Interlocuteur ,h√¥te");
                        return interlocuteurCol !== -1 && row[interlocuteurCol] === item;
                    }).length;
                case 'pays':
                    return sheetData.filter(row => {
                        const paysCol = headers.findIndex(h => h && h.includes('Pays'));
                        return paysCol !== -1 && row[paysCol] === item;
                    }).length;
                case 'lieux':
                    return sheetData.filter(row => {
                        const lieuCol = headers.findIndex(h => h && h.includes('Lieux'));
                        return lieuCol !== -1 && row[lieuCol] === item;
                    }).length;
                default:
                    return 0;
            }
        }

        function exportCurrentList() {
            const listType = document.getElementById('listType').value;
            let dataToExport = '';
            let filename = '';
            
            switch(listType) {
                case 'interlocuteurs':
                    dataToExport = allInterlocuteurs.join('\n');
                    filename = 'interlocuteurs_tournee_2026.txt';
                    break;
                case 'concerts':
                    const concerts = getConcertsList();
                    dataToExport = Object.keys(concerts).map(key => `${key}: ${concerts[key]}`).join('\n');
                    filename = 'concerts_tournee_2026.txt';
                    break;
                case 'activites':
                    const activities = getActivitiesByType();
                    dataToExport = activities.map(a => `${a.type}: ${a.count}`).join('\n');
                    filename = 'activites_tournee_2026.txt';
                    break;
                case 'pays':
                    dataToExport = allPays.join('\n');
                    filename = 'pays_tournee_2026.txt';
                    break;
                case 'lieux':
                    dataToExport = allLieux.join('\n');
                    filename = 'lieux_tournee_2026.txt';
                    break;
            }
            
            downloadFile(dataToExport, filename, 'text/plain');
            alert(`Liste export√©e: ${filename}`);
        }

        // Fonctions pour l'export de donn√©es
        function showExportModal() {
            showModal('exportModal');
            selectedExportFormat = null;
            document.getElementById('confirmExport').disabled = true;
        }

        function exportData() {
            if (!selectedExportFormat) {
                alert('Veuillez s√©lectionner un format d\'export');
                return;
            }
            
            const includeContacts = document.getElementById('includeContacts').checked;
            const includePhotos = document.getElementById('includePhotos').checked;
            const includeStats = document.getElementById('includeStats').checked;
            
            let dataToExport;
            let filename;
            let mimeType;
            
            switch(selectedExportFormat) {
                case 'csv':
                    dataToExport = exportToCSV(includeContacts, includePhotos);
                    filename = 'tournee_europe_2026.csv';
                    mimeType = 'text/csv';
                    break;
                case 'json':
                    dataToExport = exportToJSON(includeContacts, includePhotos, includeStats);
                    filename = 'tournee_europe_2026.json';
                    mimeType = 'application/json';
                    break;
                case 'pdf':
                    // Pour PDF, on ouvre une nouvelle fen√™tre avec le contenu format√©
                    exportToPDF(includeContacts, includePhotos, includeStats);
                    return;
                case 'excel':
                    dataToExport = exportToExcel(includeContacts, includePhotos);
                    filename = 'tournee_europe_2026.xlsx';
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    break;
            }
            
            if (dataToExport) {
                downloadFile(dataToExport, filename, mimeType);
                alert(`Donn√©es export√©es: ${filename}`);
                hideModal('exportModal');
            }
        }

        function exportToCSV(includeContacts, includePhotos) {
            let csvContent = '';
            
            // En-t√™tes
            const headersToExport = headers.filter((header, index) => {
                if (!includeContacts && (
                    header.includes('Mail') || 
                    header.includes('T√©l√©phone') || 
                    header.includes('Whatsapp') ||
                    header.includes('Interlocuteur')
                )) {
                    return false;
                }
                if (!includePhotos && (
                    header.includes('Photos') || 
                    header.includes('R√©pertoire')
                )) {
                    return false;
                }
                return true;
            });
            
            csvContent += headersToExport.map(header => `"${header}"`).join(',') + '\n';
            
            // Donn√©es
            sheetData.forEach(row => {
                const rowData = headersToExport.map(header => {
                    const index = headers.indexOf(header);
                    const value = row[index] || '';
                    // √âchapper les guillemets et les retours √† la ligne
                    return `"${value.replace(/"/g, '""').replace(/\n/g, ' ')}"`;
                });
                csvContent += rowData.join(',') + '\n';
            });
            
            return csvContent;
        }

        function exportToJSON(includeContacts, includePhotos, includeStats) {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalEntries: sheetData.length,
                    source: 'Journal de Bord Tourn√©e Europe 2026'
                },
                data: []
            };
            
            if (includeStats) {
                exportData.stats = {
                    totalLieux: allLieux.length,
                    totalPays: allPays.length,
                    totalInterlocuteurs: allInterlocuteurs.length,
                    totalParticipants: totalParticipants,
                    totalDureeTrajet: totalDureeTrajet,
                    totalDistance: totalDistance,
                    activityCounts: activityCounts
                };
            }
            
            sheetData.forEach((row, index) => {
                const entry = {};
                headers.forEach((header, colIndex) => {
                    if (!includeContacts && (
                        header.includes('Mail') || 
                        header.includes('T√©l√©phone') || 
                        header.includes('Whatsapp') ||
                        header.includes('Interlocuteur')
                    )) {
                        return;
                    }
                    if (!includePhotos && (
                        header.includes('Photos') || 
                        header.includes('R√©pertoire')
                    )) {
                        return;
                    }
                    entry[header] = row[colIndex] || '';
                });
                exportData.data.push(entry);
            });
            
            return JSON.stringify(exportData, null, 2);
        }

        function exportToPDF(includeContacts, includePhotos, includeStats) {
            // Cr√©er une nouvelle fen√™tre avec le contenu format√© pour impression
            const printWindow = window.open('', '_blank');
            let content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tourn√©e Europe 2026 - Rapport</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                        .entry { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
                        .entry-header { background: #3498db; color: white; padding: 10px; margin: -15px -15px 15px -15px; }
                        .section { margin-bottom: 20px; }
                        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                        .info-item { margin-bottom: 10px; }
                        .info-label { font-weight: bold; color: #2c3e50; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>üìì Journal de Bord - Tourn√©e Europe 2026</h1>
                    <p>Export g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p>
            `;
            
            if (includeStats) {
                content += `
                    <div style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h2>üìä Statistiques</h2>
                        <div class="info-grid">
                            <div class="info-item"><span class="info-label">Lieux visit√©s:</span> ${allLieux.length}</div>
                            <div class="info-item"><span class="info-label">Pays visit√©s:</span> ${allPays.length}</div>
                            <div class="info-item"><span class="info-label">Interlocuteurs:</span> ${allInterlocuteurs.length}</div>
                            <div class="info-item"><span class="info-label">Participants total:</span> ${totalParticipants}</div>
                            <div class="info-item"><span class="info-label">Dur√©e trajet total:</span> ${totalDureeTrajet.toFixed(1)}h</div>
                            <div class="info-item"><span class="info-label">Distance totale:</span> ${totalDistance.toFixed(0)}km</div>
                        </div>
                    </div>
                `;
            }
            
            sheetData.forEach((row, index) => {
                const dateIndex = 1;
                const dateStr = row[dateIndex] || 'Date non sp√©cifi√©e';
                
                content += `
                    <div class="entry">
                        <div class="entry-header">
                            <h2>Jour ${index + 1} - ${dateStr}</h2>
                        </div>
                        <div class="section">
                            <h3>Informations G√©n√©rales</h3>
                            <div class="info-grid">
                `;
                
                // Date
                const dateIndexCol = findHeaderIndex('Date:');
                if (dateIndexCol !== -1 && row[dateIndexCol]) {
                    content += `<div class="info-item"><span class="info-label">Date:</span> ${row[dateIndexCol]}</div>`;
                }
                
                // Pays
                const paysIndex = findHeaderIndex('Pays:');
                if (paysIndex !== -1 && row[paysIndex]) {
                    content += `<div class="info-item"><span class="info-label">Pays:</span> ${row[paysIndex]}</div>`;
                }
                
                content += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                </body>
                </html>
            `;
            
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
        }

        function exportToExcel(includeContacts, includePhotos) {
            // Pour Excel, on utilise le format CSV qui est compatible
            return exportToCSV(includeContacts, includePhotos);
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Affichage des informations de donn√©es
        function showDataInfo() {
            document.getElementById('dataInfo').innerHTML = `
                <div class="success-message">
                    ‚úÖ Journal charg√© avec succ√®s : ${sheetData.length} journ√©e${sheetData.length > 1 ? 's' : ''}
                    <br><small>${headers.length} colonnes d√©tect√©es ‚Ä¢ Dur√©e totale des trajets: ${totalDureeTrajet.toFixed(1)}h ‚Ä¢ Distance totale: ${totalDistance.toFixed(0)}km</small>
                    <br><small>Cliquez sur un lieu, un interlocuteur ou un pays pour filtrer les entr√©es</small>
                </div>
            `;
        }

        // Affichage des erreurs
        function showError(message) {
            document.getElementById('dataInfo').innerHTML = `
                <div class="error-message">
                    ‚ùå ${message}
                    <br><small>V√©rifiez que votre Google Sheet est bien publi√© (Fichier ‚Üí Partager ‚Üí Publier sur le web)</small>
                </div>
            `;
        }
    </script>
</body>
</html>
